#### Aggregation Framework Pipeline Stage

------

> 이미 다룬 $match, $group 외에도 집합 파이프라인에는 다양한 스테이지가 존재한다. 대표적인 스테이지로는 다음과 같은 것들이 있다.



##### $addFields

> 기존 문서들에 필드를 추가하고자 할 때 사용한다. 사용 형식은 다음과 같다.

```
{$addFields: {<newField>: <expression>, ... }}
```

> 사용 예시를 보자. 문서에 `totalPrice`라는 새로운 필드를 추가하고자 한다. 이 필드의 값은 `price`와 `quantity`라는 필드의 곱으로 정의한다고 할 때, 쿼리는 다음과 같다.

```
> db.sales.aggregate(
	[{$addFields: {totalPrice: {$multiply: ["$price", "$quantity"]}}}]
)
```

> 그리고 위 쿼리의 결과에 대한 예시는 다음과 같다.

```
전: {_id: 1, "item": "abc", "price": 10, "quantity": 2}
후: {_id: 1, "item": "abc", "price": 10, "quantity": 2, "totalPrice": 20}
```

> `totalPrice` 필드가 추가된 것을 확인할 수 있다.



##### $limit / $skip

> 파이프라인의 최종 결과물로 여러 개의 문서가 출력된다고 가정할 때, 순서 혹은 갯수를 기준으로 이 문서들을 선별적으로 출력되도록 할 수 있다. 이런 경우에 필요한 것이 $limit와 $skip이다. 
>
> $limit와 $skip의 사용법은 다음과 같다.

```
{$limit: <positive integer>}
{$skip: <positive integer>}
```

> 여러 개의 문서를 결과로 받았을 때, $limit은 출력될 문서의 개수를 지정한다. $skip은 순서를 기준으로 하여 건너뛸 문서의 개수를 지정한다. 사용 예시는 다음과 같다. 
>
> $skip과 $limit을 사용하지 않았을 경우 쿼리의 결과가 다음과 같다고 가정하자.

```
{_id: 1, ... }
{_id: 2, ... }
{_id: 3, ... }
{_id: 4, ... }
{_id: 5, ... }
{_id: 6, ... }
{_id: 7, ... }
{_id: 8, ... }
{_id: 9, ... }
```

> `{$limit: 5}`을 사용하는 경우의 결과는 다음과 같다. 문서가 다섯 개까지만 출력되는 것을 확인할 수 있다.

```
{_id: 1, ... }
{_id: 2, ... }
{_id: 3, ... }
{_id: 4, ... }
{_id: 5, ... }
```

> `{$skip: 3}`을 사용하는 경우의 결과는 다음과 같다. 처음 기준 세 개의 문서는 출력에서 제외되는 것을 확인할 수 있다.

```
{_id: 4, ... }
{_id: 5, ... }
{_id: 6, ... }
{_id: 7, ... }
{_id: 8, ... }
{_id: 9, ... }
```

> $limit과 $skip을 혼용하여 사용할 수도 있다. `{$skip: 2} {$limit: 3}`을 사용하는 경우의 결과는 다음과 같다. 처음 기준 두 개의 문서는 출력에서 제외되고, 이후 세 개의 문서가 출력되는 것을 확인할 수 있다.

```
{_id: 3, ... }
{_id: 4, ... }
{_id: 5, ... }
```



##### $count

> $count는 출력되는 문서의 개수를 파악하고자 할 때 사용한다. 사용법은 다음과 같다.

```
{$count: <field_name>}
```

> string의 형태로 필드의 이름을 정의하면, 해당 필드의 값으로 문서의 개수가 저장된다. 사용 예시는 다음과 같다. 
>
> $count를 사용하지 않았을 경우 쿼리의 결과가 다음과 같다고 가정하자.

```
{_id: 1, ... }
{_id: 2, ... }
{_id: 3, ... }
{_id: 4, ... }
{_id: 5, ... }
```

> `{$count: "total"}`을 사용한 경우 결과는 다음과 같다.

```
{"total": 3}
```



##### $sort

> 출력되는 문서들을 특정한 기준으로 정렬하고자 할 때 사용한다. 사용법은 다음과 같다.

```
{$sort: {<field1>: <order1>, <field2>: <order2>}}
```

> `order`의 값이 1이면 오름차순, -1이면 내림차순으로 정렬된다. 정렬은 `field1`, `field2` 순으로 적용된다. 사용 예시는 다음과 같다.
>
> $sort를 사용하지 않았을 경우 쿼리의 결과가 다음과 같다고 가정하자.

```
{_id: 1, "item": "jkl", ... }
{_id: 2, "item": "xyz", ... }
{_id: 3, "item": "abc", ... }
```

> `{$sort {"item": 1}}`을 사용한 경우 결과는 다음과 같다.

```
{_id: 3, "item": "abc", ... }
{_id: 1, "item": "jkl", ... }
{_id: 2, "item": "xyz", ... }
```



##### $project

> 출력되는 문서에서 특정 필드만을 선별하여 출력하거나, 출력에서 제외하고자 할 때 사용한다. 사용법은 다음과 같다.

```
{$project: {<field1>: <1 or 0>, <field2>: <1 or 0>}}
```

> 필드의 값이 1이면 해당 필드를 결과에 출력하고, 0이면 결과에서 제외한다. 사용 예시는 다음과 같다.
>
> $project를 사용하지 않았을 경우 쿼리의 결과가 다음과 같다고 가정하자.

```
{_id: 1, "item": "jkl", "price": 10, "quantity": 2}
```

> `{$project {"_id": 0, "item": 1, "price": 1, "quantity": 0}}`를 사용한 경우 결과는 다음과 같다.

```
{"item": "jkl", "price": 10}
```

> 1로 설정한 `item`과 `price` 필드만 결과에 출력되는 것을 확인할 수 있다.
>
> 그 외에 $project를 활용하여 새로운 필드를 추가하거나 기존 필드의 값을 변경하는 것도 가능하다.



