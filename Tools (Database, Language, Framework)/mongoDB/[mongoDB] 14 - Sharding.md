#### Sharding

------

> 샤딩의 개념을 이해하기 전에 먼저 Vertical Scaling과 Horizontal Scaling의 의미에 대해 짚고 넘어가자. 데이터베이스의 사용자가 많아진다면 자연스레 CPU에 과부하가 걸리고, 성능적인 이슈를 맞이하게 된다. 이 성능 이슈를 해결하는 방법으로 두 가지가 있다. 하나는 더 높은 성능을 갖는 CPU로 교체하는 방법이다. 이를 Vertical Scaling이라 한다. 다른 하나는 CPU의 개수를 늘리는 방법이다. 이를 Horizontal Scaling, 혹은 분산 컴퓨팅이라고 한다. 
>
> 샤딩은 바로 이 Horizontal Scaling과 관계가 있다. 데이터베이스에서 분산 컴퓨팅이란 데이터를 다수의 데이터베이스 서버에 나누어 저장하는 것을 의미한다. 샤딩은 분산 컴퓨팅 방식을 활용하여 데이터를 분산 저장하고 조회하는 방법을 말한다. 데이터 분산 저장을 의미하는 용어로 파티셔닝(Partitioning)이라는 용어를 사용하는데, 샤딩은 파티셔닝의 방식 중 Horizontal Partitioning에 해당된다. 샤딩을 사용하면 데이터 읽기/쓰기 속도의 향상, 저장 용량의 확장 용이, 가용성 증대와 같은 장점을 갖는다.
>
> 그런데 분산 컴퓨팅이 장점만 갖는 것은 아니다. 단점 역시 존재한다. RDBMS를 분산 컴퓨팅을 활용하여 관리한다고 할떄에는 RDBMS의 ACID 원칙을 지키기 힘들 수도 있다. Primary Key, 1:N / M:N 등의 관계에서 발생하는 많은 쿼리들로 인한 속도 저하 등이 문제가 된다. 그런데 몽고DB는 RDBMS에 비해 이러한 단점으로부터 자유롭다는 장점이 있다.  



##### CAP 정리

> 일관성(Consistency), 가용성(Availablity), 분할내성(Partition tolerance)의 조건을 모두 만족하는 분산컴퓨터 시스템이 존재할 수 없음을 의미하는 정리이다. MySQL, PostgreSQL 등과 같은 RDBMS는 일관성과 가용성의 조건을 잘 충족하도록 설계되어 있다. 반면 몽고DB는 일관성과 분할내성의 조건을 잘 충족하도록 설계되어 있어 RDBMS에 비해 샤딩을 적용하기에 용이하다.



##### 샤딩의 데이터 처리 방식

![example_1](./image/mongodb_14_1.png)

> 위의 이미지는 샤딩의 개념을 이해하기 위해 비유를 활용한 이미지이다. 샤딩을 비유하자면, 둘 이상의 직원이 여러 사용자에게 서비스를 제공하는 것을 의미한다. 직원들이 일을 나누어서 하는 것이 바로 분산 처리 방식을 활용한 샤딩의 개념이다. 이때 직원에게 일을 할당하는 사장과 같은 역할을 샤딩에서는 Config Servers가 담당한다.
>
> 반면 실제 샤딩의 처리 방식을 설명하는 이미지는 다음과 같다.

![example_1](./image/mongodb_14_2.png)

> 또 다른 이미지는 다음과 같다. 둘 이상의 샤딩에 둘 이상의 컬렉션이 분산 저장된 것을 보여준다.

![example_1](./image/mongodb_14_3.png)

> 위의 이미지에서 컬렉션1의 데이터는 A, B에 나누어 저장되어 있다. 그런데 컬렉션의 데이터를 A, B에 할당하는 기준은 무엇일까? 샤딩은 이 기준에 따라 다시 다음과 같이 분류할 수 있다.



##### 데이터 할당 기준에 따른 샤딩 구분

> ##### Hashed Sharding

![example_1](./image/mongodb_14_4.png)

> 해싱을 활용하여 데이터를 분류한다. 데이터의 특정 값을 해시 함수의 인자로 넣은 후, 실행 결과에 따라 어떤 클러스터에 할당할지 결정한다. 이 방식의 장점은 데이터가 골고루 분산되어 분산 처리의 효율을 최대화 할 수 있다는 점이다. 그러나 해시 함수에 의해 클러스터가 결정되므로 개발자가 임의적으로 데이터를 분류하고자 할 때에는 이 방식은 적합하지 않다.



> ##### Ranged Sharding

![example_1](./image/mongodb_14_5.png)

> 데이터의 특정 값을 기준으로 범위를 설정하여 분류하는 것을 의미한다. 동일 클러스터에 분류된 데이터끼리 서로 연관성을 갖는다는 장점이 있다. 그러나 어떤 범위에도 해당되지 않는 데이터가 존재할 경우 처리가 곤란하다는 단점이 있다. 또한 범위 설정 방식에 따라 특정 클러스터에 데이터가 집중되는 현상이 발생할 수 있어 분산 처리의 효율을 최대화 하기에 적합한 방식은 아니다.



> ##### Zones in Sharded Cluster

![example_1](./image/mongodb_14_6.png)

> 이 방식은 위의 두 방식에 비해 복잡하다. Ranged 방식에서 사용하듯, 데이터의 특정 값을 기준으로 범위를 설정한다. 이를 Zone이라 한다. 그리고 각 클러스터 마다 수용할 Zone을 설정한다. 데이터는 자신이 해당되는 Zone을 수용하는 클러스터들에 한해서 할당된다.